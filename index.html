<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flashino</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1d59ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/flashino-icon-192.png">

  <style>
    :root{
      --brand:#1d59ff;
      --brand2:#2e84ff;
      --bg:#0b0f1a;
      --card:#0e1424;
      --text:#edf2ff;
      --muted:#9fb0d8;
      --radius:16px;
    }
    html,body{height:100%;margin:0;background:radial-gradient(1000px 700px at 20% -10%, #183a8a55 0%, transparent 60%), var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:960px;margin:0 auto;padding:24px}
    .card{background:linear-gradient(180deg,#0e1528,#0a1020);border:1px solid #1b2750;border-radius:var(--radius);box-shadow:0 40px 80px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);overflow:hidden}
    .header{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:16px 24px;border-bottom:1px solid #1b2750;background:rgba(14,20,36,.85);backdrop-filter:saturate(140%) blur(8px)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(145deg,var(--brand),var(--brand2));box-shadow:0 8px 20px rgba(29,89,255,.35)}
    .logo img{width:30px;height:30px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}
    .title{font-size:20px;font-weight:800;letter-spacing:.2px}
    .tabs{display:flex;gap:8px}
    .tab{background:#111829;border:1px solid #1b2750;color:#cbd5ff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .tab.active{background:linear-gradient(145deg,var(--brand),var(--brand2));color:#fff;box-shadow:0 6px 14px rgba(29,89,255,.35)}
    .wrap{display:grid;place-items:center;padding:24px}
    h1{font-size:28px;margin:8px 0 0}
    .tagline{font-size:15px;color:var(--muted);margin:8px 0 0}
    .section{display:none}
    .section.active{display:block}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:8px}
    .input-row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;background:#0e1525;border:1px solid #1d2a44;padding:10px;border-radius:12px}
    input[type="text"]{background:transparent;border:none;outline:none;color:var(--text);font-size:16px;padding:10px}
    .btn{background:var(--brand);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(29,89,255,.35);transition:transform .06s ease, box-shadow .2s ease}
    .btn:active{transform:translateY(1px);box-shadow:0 6px 12px rgba(29,89,255,.3)}
    .btn.secondary{background:#1f2937;box-shadow:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .notice{margin-top:12px;font-size:14px;color:var(--muted)}
    .error{color:#fda4af;margin-top:8px;font-size:14px}
    .grid-two{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 900px){ .grid-two{grid-template-columns: 380px 1fr;} }

    /* Editor */
    #editorCard{display:flex;flex-direction:column}
    #editorToolbar{display:flex;gap:8px;flex-wrap:wrap;padding:12px;border-bottom:1px solid #1b2750;background:#0c1224}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#0f1b33;border:1px solid #1d2a44;color:#c7d2fe;padding:8px 12px;border-radius:999px;font-size:13px}
    #editor{width:100%;height:480px}
    .foot{padding:16px 24px 22px;color:#8aa4ff;font-size:13px;text-align:center}

    /* Fokus */
    .tab:focus-visible, .btn:focus-visible, input:focus-visible {
      outline: 2px solid var(--brand2);
      outline-offset: 2px;
      border-radius: 10px;
    }

    .visually-hidden{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>

  <!-- Monaco Editor via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo"><img src="assets/flashino-logo.png" alt="Flashino Logo"></div>
      <div>
        <div class="title">Flashino</div>
        <div class="tagline">Code-Load-Explode!</div>
      </div>
    </div>
    <nav class="tabs">
      <button id="tabFlash" class="tab active">Flashen</button>
      <button id="tabCode" class="tab">Coden</button>
    </nav>
  </header>

  <main class="container">
    <!-- Flashen -->
    <section id="sectionFlash" class="section active">
      <div class="card wrap" id="flashCard">
        <div style="width:100%;max-width:640px">
          <h1>Herzlich willkommen bei Flashino</h1>
          <p class="tagline">Bitte gib die IP-Adresse ein, die angezeigt wird.</p>

          <form id="flashForm" class="input-row" style="margin-top:16px">
            <label class="visually-hidden" for="ip">Zieladresse</label>
            <input id="ip" name="ip" type="text" inputmode="decimal" placeholder="z. B. 192.168.0.42 oder https://example.com" autocomplete="off" />
            <button class="btn" id="openBtn" type="submit">Weiter</button>
          </form>
          <div class="error" id="error"></div>

          <div class="notice" id="installNotice" style="margin-top:16px">
            Nicht als Web App installiert. Tippe auf „Teilen“ und dann „Zum Home‑Bildschirm hinzufügen“, um Flashino als Web App zu nutzen.
          </div>
          <div class="notice" id="installedNotice" style="display:none;margin-top:16px">
            Flashino läuft als Web App.☺️
          </div>

          <!-- Hinweis Popup blockiert -->
          <div class="notice" id="popupBlocked" style="display:none;margin-top:12px"></div>
        </div>
      </div>
    </section>

    <!-- Coden -->
    <section id="sectionCode" class="section">
      <div class="card" id="editorCard">
        <div id="editorToolbar">
          <span class="chip">Arduino/C++</span>
          <button class="btn secondary" id="btnExample" type="button">Beispiel laden</button>
          <button class="btn secondary" id="btnNew" type="button">Neu</button>
          <button class="btn" id="btnCopy" type="button">Code kopieren</button>
          <button class="btn" id="btnDownload" type="button">Als .ino speichern</button>
        </div>
        <div id="editor"></div>
      </div>
      <p class="notice" style="margin-top:12px">
        Hinweis: Dies ist ein Editor im Browser. Kompilieren/Flashen erfolgt über das Flash‑Menü.
      </p>
    </section>
  </main>

  <div class="foot">Made with ❤️ für Schüler • Flashino</div>

  <script>
    // Tabs
    const tabFlash = document.getElementById('tabFlash');
    const tabCode  = document.getElementById('tabCode');
    const sectionFlash = document.getElementById('sectionFlash');
    const sectionCode  = document.getElementById('sectionCode');

    function setTab(which){
      const isFlash = which === 'flash';
      tabFlash.classList.toggle('active', isFlash);
      tabCode.classList.toggle('active', !isFlash);
      sectionFlash.classList.toggle('active', isFlash);
      sectionCode.classList.toggle('active', !isFlash);
    }
    tabFlash.addEventListener('click', () => setTab('flash'));
    tabCode.addEventListener('click',  () => setTab('code'));

    // PWA Hinweise
    function isStandalone(){ return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true; }
    function updateInstallUI(){
      const installNotice = document.getElementById('installNotice');
      const installedNotice = document.getElementById('installedNotice');
      if (isStandalone()) { installNotice.style.display='none'; installedNotice.style.display='block'; }
      else { installNotice.style.display='block'; installedNotice.style.display='none'; }
    }
    updateInstallUI();
    window.matchMedia('(display-mode: standalone)').addEventListener('change', updateInstallUI);

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // Hilfsfunktionen zur Validierung
    function isValidIPv4(host){
      if (!/^(\d{1,3}\.){3}\d{1,3}$/.test(host)) return false;
      return host.split('.').every(o => +o>=0 && +o<=255);
    }
    function isValidIPv6(host){
      return /^[0-9a-f:]+$/i.test(host) && host.includes(':');
    }
    function isLocalName(host){
      return /^(localhost|flashino|[a-z0-9-]+\.local)$/i.test(host);
    }

    // Port 5000 anfügen, falls kein Port vorhanden ist
    function ensurePort5000(url){
      try{
        const u = new URL(url);
        if (!u.port) {
          u.port = '5000';
        }
        return u.toString();
      }catch{
        return url;
      }
    }

    // Normalisiert Eingabe und prüft URL
    function normalizeUrl(input){
      let value = (input || '').trim();
      if (!value) return null;
      if (!/^https?:\/\//i.test(value)) value = 'http://' + value;
      try{
        const url = new URL(value);
        const host = url.hostname;
        const ipv4 = isValidIPv4(host);
        const ipv6 = isValidIPv6(host);
        const local = isLocalName(host);

        const httpsDomain = url.protocol === 'https:' && !(ipv4 || ipv6 || local);
        const httpAndLocal = url.protocol === 'http:' && (ipv4 || ipv6 || local);

        if (httpsDomain || httpAndLocal || ipv4 || ipv6 || local) {
          return ensurePort5000(url.toString());
        }
        return null;
      }catch{
        return null;
      }
    }

    // Öffnet die URL im neuen Tab beim Formular-Submit
    const ipInput = document.getElementById('ip');
    const errorEl = document.getElementById('error');
    const flashForm = document.getElementById('flashForm');
    const popupBlockedEl = document.getElementById('popupBlocked');

    flashForm.addEventListener('submit', e => {
      e.preventDefault();
      popupBlockedEl.style.display = 'none';
      popupBlockedEl.textContent = '';

      const normalized = normalizeUrl(ipInput.value);
      if (!normalized) {
        errorEl.textContent = 'Ungültige Adresse. Erlaubt: http/https mit IP (z. B. 192.168.0.42), IPv6 (z. B. http://[::1]), localhost oder *.local; Domains mit https.';
        return;
      }
      errorEl.textContent = '';

      const w = window.open(normalized, '_blank', 'noopener,noreferrer');
      if (!w) {
        popupBlockedEl.style.display = 'block';
        popupBlockedEl.innerHTML = `Popup wurde blockiert. Öffne die Seite manuell: <a href="${normalized}" target="_blank" rel="noopener noreferrer">${normalized}</a>`;
      }
    });

    // iOS Hinweis
    const ua = navigator.userAgent.toLowerCase();
    if (/iphone|ipad|ipod/.test(ua) && !isStandalone()) {
      const el = document.getElementById('installNotice');
      if (el) el.textContent = 'iOS: Tippe unten auf „Teilen“ → „Zum Home‑Bildschirm“.';
    }

    // ---- Coden: Monaco Editor ----
    let editor;
    const example = `// Flashino – Arduino Beispiel
// Blinkt "FLASHINO" als Morsecode mit der eingebauten LED

const int LED = LED_BUILTIN;
const int UNIT = 150; // Basisdauer in Millisekunden

struct MorseMap { char c; const char* code; };
MorseMap MORSE_TABLE[] = {
  {'A', ".-"},   {'B', "-..."}, {'C', "-.-."}, {'D', "-.."},  {'E', "."},
  {'F', "..-."}, {'G', "--."},  {'H', "...."}, {'I', ".."},   {'J', ".---"},
  {'K', "-.-"},  {'L', ".-.."}, {'M', "--"},   {'N', "-."},   {'O', "---"},
  {'P', ".--."}, {'Q', "--.-"}, {'R', ".-."},  {'S', "..."},  {'T', "-"},
  {'U', "..-"},  {'V', "...-"}, {'W', ".--"},  {'X', "-..-"}, {'Y', "-.--"},
  {'Z', "--.."}
};

const char* MESSAGE = "FLASHINO";

void dot() {
  digitalWrite(LED, HIGH); delay(UNIT);
  digitalWrite(LED, LOW);  delay(UNIT);
}
void dash() {
  digitalWrite(LED, HIGH); delay(3*UNIT);
  digitalWrite(LED, LOW);  delay(UNIT);
}
const char* lookupMorse(char ch) {
  if (ch >= 'a' && ch <= 'z') ch = ch - 'a' + 'A';
  for (unsigned int i=0;i<sizeof(MORSE_TABLE)/sizeof(MorseMap);i++)
    if (MORSE_TABLE[i].c == ch) return MORSE_TABLE[i].code;
  return nullptr;
}
void blinkChar(char ch) {
  const char* code = lookupMorse(ch);
  if (!code) return;
  for (const char* p=code; *p; ++p) (*p=='.') ? dot() : dash();
  delay(2*UNIT);
}
void blinkWord(const char* text) {
  for (const char* p=text; *p; ++p) {
    if (*p==' ') delay(6*UNIT);
    else blinkChar(*p);
  }
  delay(7*UNIT);
}
void setup(){ pinMode(LED, OUTPUT); }
void loop(){ blinkWord(MESSAGE); }
`;

    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
    window.MonacoEnvironment = { getWorkerUrl: function () { return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
      self.MonacoEnvironment = { baseUrl: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/' };
      importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/base/worker/workerMain.js');`)}`; }};

    function initEditor(){
      require(['vs/editor/editor.main'], function(){
        editor = monaco.editor.create(document.getElementById('editor'), {
          value: example,
          language: 'cpp',
          theme: 'vs-dark',
          automaticLayout: true,
          fontSize: 14,
          minimap: { enabled: false },
          scrollbar: { verticalScrollbarSize: 12, horizontalScrollbarSize: 12 },
          wordWrap: 'on',
          ariaLabel: 'Arduino C++ Editor'
        });
      });
    }
    let editorInitialized = false;
    tabCode.addEventListener('click', () => {
      if (!editorInitialized) { initEditor(); editorInitialized = true; }
    });

    document.getElementById('btnExample').addEventListener('click', () => {
      if (editor) editor.setValue(example);
    });
    document.getElementById('btnNew').addEventListener('click', () => {
      if (editor) editor.setValue(`// Neuer Sketch
void setup(){}

void loop(){}
`);
    });

    const btnCopy = document.getElementById('btnCopy');
    btnCopy.addEventListener('click', async () => {
      if (!editor) return;
      try {
        await navigator.clipboard.writeText(editor.getValue());
        const old = btnCopy.textContent;
        btnCopy.textContent = '✔️ Kopiert';
        btnCopy.disabled = true;
        setTimeout(() => { btnCopy.textContent = old; btnCopy.disabled = false; }, 1500);
      } catch (e) {
        const ta = document.createElement('textarea');
        ta.value = editor.getValue();
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        try { document.execCommand('copy'); } catch {}
        ta.remove();
        const old = btnCopy.textContent;
        btnCopy.textContent = '✔️ Kopiert';
        btnCopy.disabled = true;
        setTimeout(() => { btnCopy.textContent = old; btnCopy.disabled = false; }, 1500);
      }
    });

    document.getElementById('btnDownload').addEventListener('click', () => {
      if (!editor) return;
      const blob = new Blob([editor.getValue()], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'flashino_sketch.ino';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
